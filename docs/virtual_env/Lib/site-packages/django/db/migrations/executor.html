<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>executor.py</title>
  <link rel="stylesheet" href="..\..\..\..\..\..\pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>executor.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.apps.registry</span> <span class="kn">import</span> <span class="n">apps</span> <span class="k">as</span> <span class="n">global_apps</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">migrations</span><span class="p">,</span> <span class="n">router</span>

<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">InvalidMigrationPlan</span>
<span class="kn">from</span> <span class="nn">.loader</span> <span class="kn">import</span> <span class="n">MigrationLoader</span>
<span class="kn">from</span> <span class="nn">.recorder</span> <span class="kn">import</span> <span class="n">MigrationRecorder</span>
<span class="kn">from</span> <span class="nn">.state</span> <span class="kn">import</span> <span class="n">ProjectState</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>End-to-end migration execution - load migrations and run them up or down
to a specified set of targets.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">MigrationExecutor</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">progress_callback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loader</span> <span class="o">=</span> <span class="n">MigrationLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span> <span class="o">=</span> <span class="n">MigrationRecorder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span> <span class="o">=</span> <span class="n">progress_callback</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Given a set of targets, return a list of (Migration instance, backwards?).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">migration_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">clean_start</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">plan</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">clean_start</span><span class="p">:</span>
            <span class="n">applied</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">applied</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">applied_migrations</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>If the target is (app_label, None), that means unmigrate everything</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">root</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">root_nodes</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">root</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">migration</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">backwards_plan</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">migration</span> <span class="ow">in</span> <span class="n">applied</span><span class="p">:</span>
                                <span class="n">plan</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">migration</span><span class="p">],</span> <span class="kc">True</span><span class="p">))</span>
                                <span class="n">applied</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">migration</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>If the migration is already applied, do backwards mode,
otherwise do forwards mode.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">elif</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">applied</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>Don't migrate backwards all the way to the target node (that
may roll back dependencies in other apps that don't need to
be rolled back); instead roll back through target's immediate
child(ren) in the same app, and no further.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">next_in_app</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">node_map</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">children</span>
                    <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">next_in_app</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">migration</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">backwards_plan</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">migration</span> <span class="ow">in</span> <span class="n">applied</span><span class="p">:</span>
                            <span class="n">plan</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">migration</span><span class="p">],</span> <span class="kc">True</span><span class="p">))</span>
                            <span class="n">applied</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">migration</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">migration</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">forwards_plan</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">migration</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">applied</span><span class="p">:</span>
                        <span class="n">plan</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">migration</span><span class="p">],</span> <span class="kc">False</span><span class="p">))</span>
                        <span class="n">applied</span><span class="p">[</span><span class="n">migration</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">migration</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">plan</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>Create a project state including all the applications without
migrations and applied migrations if with_applied_migrations=True.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_create_project_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_applied_migrations</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">state</span> <span class="o">=</span> <span class="n">ProjectState</span><span class="p">(</span><span class="n">real_apps</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">unmigrated_apps</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">with_applied_migrations</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>Create the forwards plan Django would follow on an empty database</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">full_plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">migration_plan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">leaf_nodes</span><span class="p">(),</span> <span class="n">clean_start</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">applied_migrations</span> <span class="o">=</span> <span class="p">{</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">applied_migrations</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">migration</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">full_plan</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">migration</span> <span class="ow">in</span> <span class="n">applied_migrations</span><span class="p">:</span>
                    <span class="n">migration</span><span class="o">.</span><span class="n">mutate_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">preserve</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>Migrate the database up to the given targets.</p>
<p>Django first needs to create all project states before a migration is
(un)applied and in a second step run all the database operations.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">migrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">plan</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fake</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fake_initial</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>The django_migrations table must be present to record applied
migrations.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">ensure_schema</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">plan</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">migration_plan</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>Create the forwards plan Django would follow on an empty database</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">full_plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">migration_plan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">leaf_nodes</span><span class="p">(),</span> <span class="n">clean_start</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">all_forwards</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="ow">not</span> <span class="n">backwards</span> <span class="k">for</span> <span class="n">mig</span><span class="p">,</span> <span class="n">backwards</span> <span class="ow">in</span> <span class="n">plan</span><span class="p">)</span>
        <span class="n">all_backwards</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">backwards</span> <span class="k">for</span> <span class="n">mig</span><span class="p">,</span> <span class="n">backwards</span> <span class="ow">in</span> <span class="n">plan</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">plan</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>The resulting state should include applied migrations.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_project_state</span><span class="p">(</span><span class="n">with_applied_migrations</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">all_forwards</span> <span class="o">==</span> <span class="n">all_backwards</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>This should only happen if there's a mixed plan</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">raise</span> <span class="n">InvalidMigrationPlan</span><span class="p">(</span>
                <span class="s2">&quot;Migration plans with both forwards and backwards migrations &quot;</span>
                <span class="s2">&quot;are not supported. Please split your migration process into &quot;</span>
                <span class="s2">&quot;separate plans of only forwards OR backwards migrations.&quot;</span><span class="p">,</span>
                <span class="n">plan</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">all_forwards</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>The resulting state should still include applied migrations.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_project_state</span><span class="p">(</span><span class="n">with_applied_migrations</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_migrate_all_forwards</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">plan</span><span class="p">,</span> <span class="n">full_plan</span><span class="p">,</span> <span class="n">fake</span><span class="o">=</span><span class="n">fake</span><span class="p">,</span> <span class="n">fake_initial</span><span class="o">=</span><span class="n">fake_initial</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>No need to check for <code>elif all_backwards</code> here, as that condition
would always evaluate to true.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_migrate_all_backwards</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">full_plan</span><span class="p">,</span> <span class="n">fake</span><span class="o">=</span><span class="n">fake</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_replacements</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">state</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Take a list of 2-tuples of the form (migration instance, False) and
apply them in the order they occur in the full_plan.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_migrate_all_forwards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">plan</span><span class="p">,</span> <span class="n">full_plan</span><span class="p">,</span> <span class="n">fake</span><span class="p">,</span> <span class="n">fake_initial</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">migrations_to_run</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">plan</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">migration</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">full_plan</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">migrations_to_run</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>We remove every migration that we applied from these sets so
that we can bail out once the last migration has been applied
and don't always run until the very end of the migration
process.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">break</span>
            <span class="k">if</span> <span class="n">migration</span> <span class="ow">in</span> <span class="n">migrations_to_run</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;apps&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;render_start&quot;</span><span class="p">)</span>
                    <span class="n">state</span><span class="o">.</span><span class="n">apps</span>  <span class="c1"># Render all -- performance critical</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;render_success&quot;</span><span class="p">)</span>
                <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_migration</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">migration</span><span class="p">,</span> <span class="n">fake</span><span class="o">=</span><span class="n">fake</span><span class="p">,</span> <span class="n">fake_initial</span><span class="o">=</span><span class="n">fake_initial</span><span class="p">)</span>
                <span class="n">migrations_to_run</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">migration</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">state</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>Take a list of 2-tuples of the form (migration instance, True) and
unapply them in reverse order they occur in the full_plan.</p>
<p>Since unapplying a migration requires the project state prior to that
migration, Django will compute the migration states before each of them
in a first run over the plan and then unapply them in a second run over
the plan.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_migrate_all_backwards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan</span><span class="p">,</span> <span class="n">full_plan</span><span class="p">,</span> <span class="n">fake</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">migrations_to_run</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">plan</span><span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>Holds all migration states prior to the migrations being unapplied</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">states</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_project_state</span><span class="p">()</span>
        <span class="n">applied_migrations</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">applied_migrations</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;render_start&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">migration</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">full_plan</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">migrations_to_run</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>We remove every migration that we applied from this set so
that we can bail out once the last migration has been applied
and don't always run until the very end of the migration
process.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">break</span>
            <span class="k">if</span> <span class="n">migration</span> <span class="ow">in</span> <span class="n">migrations_to_run</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;apps&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                    <span class="n">state</span><span class="o">.</span><span class="n">apps</span>  <span class="c1"># Render all -- performance critical</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>The state before this migration</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">states</span><span class="p">[</span><span class="n">migration</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>The old state keeps as-is, we continue with the new state</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">state</span> <span class="o">=</span> <span class="n">migration</span><span class="o">.</span><span class="n">mutate_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">preserve</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">migrations_to_run</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">migration</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">migration</span> <span class="ow">in</span> <span class="n">applied_migrations</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>Only mutate the state if the migration is actually applied
to make sure the resulting state doesn't include changes
from unrelated migrations.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">migration</span><span class="o">.</span><span class="n">mutate_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">preserve</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;render_success&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">migration</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">plan</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unapply_migration</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="n">migration</span><span class="p">],</span> <span class="n">migration</span><span class="p">,</span> <span class="n">fake</span><span class="o">=</span><span class="n">fake</span><span class="p">)</span>
            <span class="n">applied_migrations</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">migration</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>Generate the post migration state by starting from the state before
the last migration is unapplied and mutating it to include all the
remaining applied migrations.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">last_unapplied_migration</span> <span class="o">=</span> <span class="n">plan</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="n">last_unapplied_migration</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">migration</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">full_plan</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">migration</span> <span class="o">==</span> <span class="n">last_unapplied_migration</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">migration</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">full_plan</span><span class="p">[</span><span class="n">index</span><span class="p">:]:</span>
                    <span class="k">if</span> <span class="n">migration</span> <span class="ow">in</span> <span class="n">applied_migrations</span><span class="p">:</span>
                        <span class="n">migration</span><span class="o">.</span><span class="n">mutate_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">preserve</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">state</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <p>Take a migration plan and return a list of collected SQL statements
that represent the best-efforts version of that plan.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">collect_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">statements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">migration</span><span class="p">,</span> <span class="n">backwards</span> <span class="ow">in</span> <span class="n">plan</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">schema_editor</span><span class="p">(</span><span class="n">collect_sql</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">atomic</span><span class="o">=</span><span class="n">migration</span><span class="o">.</span><span class="n">atomic</span><span class="p">)</span> <span class="k">as</span> <span class="n">schema_editor</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">project_state</span><span class="p">((</span><span class="n">migration</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span> <span class="n">migration</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">at_end</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">backwards</span><span class="p">:</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">migration</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">schema_editor</span><span class="p">,</span> <span class="n">collect_sql</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">migration</span><span class="o">.</span><span class="n">unapply</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">schema_editor</span><span class="p">,</span> <span class="n">collect_sql</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">statements</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">schema_editor</span><span class="o">.</span><span class="n">collected_sql</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">statements</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>Run a migration forwards.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">apply_migration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">migration</span><span class="p">,</span> <span class="n">fake</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fake_initial</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">migration_recorded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;apply_start&quot;</span><span class="p">,</span> <span class="n">migration</span><span class="p">,</span> <span class="n">fake</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fake</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fake_initial</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <p>Test to see if this is an already-applied initial migration</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">applied</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_soft_applied</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">migration</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">applied</span><span class="p">:</span>
                    <span class="n">fake</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fake</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>Alright, do it normally</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">schema_editor</span><span class="p">(</span><span class="n">atomic</span><span class="o">=</span><span class="n">migration</span><span class="o">.</span><span class="n">atomic</span><span class="p">)</span> <span class="k">as</span> <span class="n">schema_editor</span><span class="p">:</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">migration</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">schema_editor</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">record_migration</span><span class="p">(</span><span class="n">migration</span><span class="p">)</span>
                    <span class="n">migration_recorded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">migration_recorded</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record_migration</span><span class="p">(</span><span class="n">migration</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      <p>Report progress</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;apply_success&quot;</span><span class="p">,</span> <span class="n">migration</span><span class="p">,</span> <span class="n">fake</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">record_migration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">migration</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>For replacement migrations, record individual statuses</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">migration</span><span class="o">.</span><span class="n">replaces</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">migration</span><span class="o">.</span><span class="n">replaces</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">record_applied</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">record_applied</span><span class="p">(</span><span class="n">migration</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span> <span class="n">migration</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p>Run a migration backwards.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">unapply_migration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">migration</span><span class="p">,</span> <span class="n">fake</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;unapply_start&quot;</span><span class="p">,</span> <span class="n">migration</span><span class="p">,</span> <span class="n">fake</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fake</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">schema_editor</span><span class="p">(</span><span class="n">atomic</span><span class="o">=</span><span class="n">migration</span><span class="o">.</span><span class="n">atomic</span><span class="p">)</span> <span class="k">as</span> <span class="n">schema_editor</span><span class="p">:</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">migration</span><span class="o">.</span><span class="n">unapply</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">schema_editor</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>For replacement migrations, record individual statuses</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">migration</span><span class="o">.</span><span class="n">replaces</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">migration</span><span class="o">.</span><span class="n">replaces</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">record_unapplied</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">record_unapplied</span><span class="p">(</span><span class="n">migration</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span> <span class="n">migration</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      <p>Report progress</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress_callback</span><span class="p">(</span><span class="s2">&quot;unapply_success&quot;</span><span class="p">,</span> <span class="n">migration</span><span class="p">,</span> <span class="n">fake</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <p>Mark replacement migrations applied if their replaced set all are.</p>
<p>Do this unconditionally on every migrate, rather than just when
migrations are applied or unapplied, to correctly handle the case
when a new squash migration is pushed to a deployment that already had
all its replaced migrations applied. In this case no new migration will
be applied, but the applied state of the squashed migration must be
maintained.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">check_replacements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">applied</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">applied_migrations</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">migration</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">replacements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">all_applied</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">m</span> <span class="ow">in</span> <span class="n">applied</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">migration</span><span class="o">.</span><span class="n">replaces</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">all_applied</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">applied</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">record_applied</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <p>Test whether a migration has been implicitly applied - that the
tables or columns it would create exist. This is intended only for use
on initial migrations (as it only looks for CreateModel and AddField).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">detect_soft_applied</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_state</span><span class="p">,</span> <span class="n">migration</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      <p>No need to detect tables for proxy models, unmanaged models, or
models that can't be migrated on the current database.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">def</span> <span class="nf">should_skip_detecting_model</span><span class="p">(</span><span class="n">migration</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">return</span> <span class="p">(</span>
                <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">proxy</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">managed</span> <span class="ow">or</span> <span class="ow">not</span>
                <span class="n">router</span><span class="o">.</span><span class="n">allow_migrate</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">alias</span><span class="p">,</span> <span class="n">migration</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span>
                    <span class="n">model_name</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">migration</span><span class="o">.</span><span class="n">initial</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      <p>Bail if the migration isn't the first one in its app</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">app</span> <span class="o">==</span> <span class="n">migration</span><span class="o">.</span><span class="n">app_label</span> <span class="k">for</span> <span class="n">app</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">migration</span><span class="o">.</span><span class="n">dependencies</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">project_state</span>
        <span class="k">elif</span> <span class="n">migration</span><span class="o">.</span><span class="n">initial</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      <p>Bail if it's NOT an initial migration</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">project_state</span>

        <span class="k">if</span> <span class="n">project_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">after_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">project_state</span><span class="p">((</span><span class="n">migration</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span> <span class="n">migration</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">at_end</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">after_state</span> <span class="o">=</span> <span class="n">migration</span><span class="o">.</span><span class="n">mutate_state</span><span class="p">(</span><span class="n">project_state</span><span class="p">)</span>
        <span class="n">apps</span> <span class="o">=</span> <span class="n">after_state</span><span class="o">.</span><span class="n">apps</span>
        <span class="n">found_create_model_migration</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">found_add_field_migration</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">existing_table_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">introspection</span><span class="o">.</span><span class="n">table_names</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      <p>Make sure all create model and add field operations are done</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">operation</span> <span class="ow">in</span> <span class="n">migration</span><span class="o">.</span><span class="n">operations</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">migrations</span><span class="o">.</span><span class="n">CreateModel</span><span class="p">):</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">migration</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span> <span class="n">operation</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">swapped</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      <p>We have to fetch the model to test with from the
main app cache, as it's not a direct dependency.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="n">model</span> <span class="o">=</span> <span class="n">global_apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">swapped</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">should_skip_detecting_model</span><span class="p">(</span><span class="n">migration</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_table_names</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">project_state</span>
                <span class="n">found_create_model_migration</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">migrations</span><span class="o">.</span><span class="n">AddField</span><span class="p">):</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">migration</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span> <span class="n">operation</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">swapped</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      <p>We have to fetch the model to test with from the
main app cache, as it's not a direct dependency.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="n">model</span> <span class="o">=</span> <span class="n">global_apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">swapped</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">should_skip_detecting_model</span><span class="p">(</span><span class="n">migration</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">table</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      <p>Handle implicit many-to-many tables created by AddField.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">many_to_many</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_table_names</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">project_state</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">found_add_field_migration</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">continue</span>

                <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">column</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">introspection</span><span class="o">.</span><span class="n">get_table_description</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">(),</span> <span class="n">table</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">project_state</span>
                <span class="n">found_add_field_migration</span> <span class="o">=</span> <span class="kc">True</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      <p>If we get this far and we found at least one CreateModel or AddField migration,
the migration is considered implicitly applied.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="p">(</span><span class="n">found_create_model_migration</span> <span class="ow">or</span> <span class="n">found_add_field_migration</span><span class="p">),</span> <span class="n">after_state</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
