<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>autodetector.py</title>
  <link rel="stylesheet" href="..\..\..\..\..\..\pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>autodetector.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.db.migrations</span> <span class="kn">import</span> <span class="n">operations</span>
<span class="kn">from</span> <span class="nn">django.db.migrations.migration</span> <span class="kn">import</span> <span class="n">Migration</span>
<span class="kn">from</span> <span class="nn">django.db.migrations.operations.models</span> <span class="kn">import</span> <span class="n">AlterModelOptions</span>
<span class="kn">from</span> <span class="nn">django.db.migrations.optimizer</span> <span class="kn">import</span> <span class="n">MigrationOptimizer</span>
<span class="kn">from</span> <span class="nn">django.db.migrations.questioner</span> <span class="kn">import</span> <span class="n">MigrationQuestioner</span>
<span class="kn">from</span> <span class="nn">django.db.migrations.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">COMPILED_REGEX_TYPE</span><span class="p">,</span> <span class="n">RegexObject</span><span class="p">,</span> <span class="n">get_migration_name_timestamp</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">django.utils.topological_sort</span> <span class="kn">import</span> <span class="n">stable_topological_sort</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>Take a pair of ProjectStates and compare them to see what the first would
need doing to make it match the second (the second usually being the
project's current state).</p>
<p>Note that this naturally operates on entire projects at a time,
as it's likely that changes interact (for example, you can't
add a ForeignKey without having a migration to add the table it
depends on first). A user interface may offer single-app usage
if it wishes, with the caveat that it may not always be possible.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">MigrationAutodetector</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_state</span><span class="p">,</span> <span class="n">to_state</span><span class="p">,</span> <span class="n">questioner</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">from_state</span> <span class="o">=</span> <span class="n">from_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_state</span> <span class="o">=</span> <span class="n">to_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">questioner</span> <span class="o">=</span> <span class="n">questioner</span> <span class="ow">or</span> <span class="n">MigrationQuestioner</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">existing_apps</span> <span class="o">=</span> <span class="p">{</span><span class="n">app</span> <span class="k">for</span> <span class="n">app</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">from_state</span><span class="o">.</span><span class="n">models</span><span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Main entry point to produce a list of applicable changes.
Take a graph to base names on and an optional set of apps
to try and restrict to (restriction is not guaranteed)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">trim_to_apps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">convert_apps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">migration_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">changes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detect_changes</span><span class="p">(</span><span class="n">convert_apps</span><span class="p">,</span> <span class="n">graph</span><span class="p">)</span>
        <span class="n">changes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arrange_for_graph</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">migration_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trim_to_apps</span><span class="p">:</span>
            <span class="n">changes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trim_to_apps</span><span class="p">(</span><span class="n">changes</span><span class="p">,</span> <span class="n">trim_to_apps</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">changes</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>Recursive deconstruction for a field and its arguments.
Used for full comparison for rename/alter; sometimes a single-level
deconstruction will not compare correctly.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">deep_deconstruct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">deep_deconstruct</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deep_deconstruct</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">deep_deconstruct</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deep_deconstruct</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">args</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">deep_deconstruct</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">keywords</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">COMPILED_REGEX_TYPE</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">RegexObject</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>If this is a type that implements 'deconstruct' as an instance method,
avoid treating this as being deconstructible itself - see #22951</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">return</span> <span class="n">obj</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;deconstruct&#39;</span><span class="p">):</span>
            <span class="n">deconstructed</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">deconstruct</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>we have a field which also returns a name</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">deconstructed</span> <span class="o">=</span> <span class="n">deconstructed</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">path</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">deconstructed</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">path</span><span class="p">,</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">deep_deconstruct</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">args</span><span class="p">],</span>
                <span class="p">{</span>
                    <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">deep_deconstruct</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>Return a definition of the fields that ignores field names and
what related fields actually relate to. Used for detecting renames (as,
of course, the related fields change during renames).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">only_relation_agnostic_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">fields_def</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
            <span class="n">deconstruction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deep_deconstruct</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">deconstruction</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;to&#39;</span><span class="p">]</span>
            <span class="n">fields_def</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deconstruction</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fields_def</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>Return a dict of migration plans which will achieve the
change from from_state to to_state. The dict has app labels
as keys and a list of migrations as values.</p>
<p>The resulting migrations aren't specially named, but the names
do matter for dependencies inside the set.</p>
<p>convert_apps is the list of apps to convert to use migrations
(i.e. to make initial migrations for, in the usual case)</p>
<p>graph is an optional argument that, if provided, can help improve
dependency generation and avoid potential circular dependencies.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_detect_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">convert_apps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>The first phase is generating all the operations for each app
and gathering them into a big per-app list.
Then go through that list, order it, and split into migrations to
resolve dependencies caused by M2Ms and FKs.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">generated_operations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">altered_indexes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">altered_constraints</span> <span class="o">=</span> <span class="p">{}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>Prepare some old/new state and model lists, separating
proxy models and ignoring unmigrated apps.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">old_apps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_state</span><span class="o">.</span><span class="n">concrete_apps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_apps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_state</span><span class="o">.</span><span class="n">apps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_model_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_proxy_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_unmanaged_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_model_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_proxy_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_unmanaged_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">al</span><span class="p">,</span> <span class="n">mn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_state</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">al</span><span class="p">,</span> <span class="n">mn</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">managed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">old_unmanaged_keys</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">al</span><span class="p">,</span> <span class="n">mn</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">al</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_state</span><span class="o">.</span><span class="n">real_apps</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">proxy</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">old_proxy_keys</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">al</span><span class="p">,</span> <span class="n">mn</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">old_model_keys</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">al</span><span class="p">,</span> <span class="n">mn</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">al</span><span class="p">,</span> <span class="n">mn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_state</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">al</span><span class="p">,</span> <span class="n">mn</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">managed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_unmanaged_keys</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">al</span><span class="p">,</span> <span class="n">mn</span><span class="p">))</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">al</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_state</span><span class="o">.</span><span class="n">real_apps</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">convert_apps</span> <span class="ow">and</span> <span class="n">al</span> <span class="ow">in</span> <span class="n">convert_apps</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">proxy</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">new_proxy_keys</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">al</span><span class="p">,</span> <span class="n">mn</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">new_model_keys</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">al</span><span class="p">,</span> <span class="n">mn</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>Renames have to come first</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_renamed_models</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>Prepare lists of fields and generate through model map</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_field_lists</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_through_model_map</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>Generate non-rename model operations</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_deleted_models</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_created_models</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_deleted_proxies</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_created_proxies</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_altered_options</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_altered_managers</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>Create the altered indexes and store them in self.altered_indexes.
This avoids the same computation in generate_removed_indexes()
and generate_added_indexes().</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">create_altered_indexes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_altered_constraints</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Generate index removal operations before field is removed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_removed_constraints</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_removed_indexes</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>Generate field operations</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_renamed_fields</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_removed_fields</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_added_fields</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_altered_fields</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_altered_unique_together</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_altered_index_together</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_added_indexes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_added_constraints</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_altered_db_table</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_altered_order_with_respect_to</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sort_migrations</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_migration_list</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_migrations</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">migrations</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>Prepare field lists and a list of the fields that used through models
in the old state so dependencies can be made from the through model
deletion to the field that uses it.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_prepare_field_lists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">kept_model_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_model_keys</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_model_keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kept_proxy_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_proxy_keys</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_proxy_keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kept_unmanaged_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_unmanaged_keys</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_unmanaged_keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">through_users</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_field_keys</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kept_model_keys</span>
            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span>
                <span class="n">app_label</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">renamed_models</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">),</span> <span class="n">model_name</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">fields</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_field_keys</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kept_model_keys</span>
            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span>
        <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>Through model map generation.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_generate_through_model_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_model_keys</span><span class="p">):</span>
            <span class="n">old_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renamed_models</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">),</span> <span class="n">model_name</span><span class="p">)</span>
            <span class="n">old_model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">old_model_name</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">old_model_state</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                <span class="n">old_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">old_model_name</span><span class="p">)</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">old_field</span><span class="p">,</span> <span class="s2">&quot;remote_field&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">old_field</span><span class="o">.</span><span class="n">remote_field</span><span class="p">,</span> <span class="s2">&quot;through&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="ow">not</span> <span class="n">old_field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">auto_created</span><span class="p">):</span>
                    <span class="n">through_key</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">old_field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span>
                        <span class="n">old_field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">through_users</span><span class="p">[</span><span class="n">through_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">old_model_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>Return the resolved dependency and a boolean denoting whether or not
it was swappable.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_resolve_dependency</span><span class="p">(</span><span class="n">dependency</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;__setting__&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dependency</span><span class="p">,</span> <span class="kc">False</span>
        <span class="n">resolved_app_label</span><span class="p">,</span> <span class="n">resolved_object_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">resolved_app_label</span><span class="p">,</span> <span class="n">resolved_object_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="o">+</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="kc">True</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>Chop the lists of operations up into migrations with dependencies on
each other. Do this by going through an app's list of operations until
one is found that has an outgoing dependency that isn't in another
app's migration yet (hasn't been chopped off its list). Then chop off
the operations before it into a migration and move onto the next app.
If the loops completes without doing anything, there's a circular
dependency (which <em>should</em> be impossible as the operations are
all split at this point so they can't depend and be depended on).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_build_migration_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">migrations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">num_ops</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">generated_operations</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">chop_mode</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="n">num_ops</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>On every iteration, we step through all the apps and see if there
is a completed set of operations.
If we find that a subset of the operations are complete we can
try to chop it off from the rest and continue, but we only
do this if we've already been through the list once before
without any chopping and nothing has changed.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">for</span> <span class="n">app_label</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generated_operations</span><span class="p">):</span>
                <span class="n">chopped</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">dependencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">operation</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generated_operations</span><span class="p">[</span><span class="n">app_label</span><span class="p">]):</span>
                    <span class="n">deps_satisfied</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">operation_dependencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">operation</span><span class="o">.</span><span class="n">_auto_deps</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <p>Temporarily resolve the swappable dependency to
prevent circular references. While keeping the
dependency checks on the resolved model, add the
swappable dependencies.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                        <span class="n">original_dep</span> <span class="o">=</span> <span class="n">dep</span>
                        <span class="n">dep</span><span class="p">,</span> <span class="n">is_swappable_dep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_dependency</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">dep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">app_label</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>External app dependency. See if it's not yet
satisfied.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                            <span class="k">for</span> <span class="n">other_operation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">generated_operations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dep</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[]):</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_dependency</span><span class="p">(</span><span class="n">other_operation</span><span class="p">,</span> <span class="n">dep</span><span class="p">):</span>
                                    <span class="n">deps_satisfied</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="k">break</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">deps_satisfied</span><span class="p">:</span>
                                <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">is_swappable_dep</span><span class="p">:</span>
                                    <span class="n">operation_dependencies</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">original_dep</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">original_dep</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                <span class="k">elif</span> <span class="n">dep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">migrations</span><span class="p">:</span>
                                    <span class="n">operation_dependencies</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">dep</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">migrations</span><span class="p">[</span><span class="n">dep</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>If we can't find the other app, we add a first/last dependency,
but only if we've already been through once and checked everything</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                                    <span class="k">if</span> <span class="n">chop_mode</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <p>If the app already exists, we add a dependency on the last migration,
as we don't know which migration contains the target field.
If it's not yet migrated or has no migrations, we use <strong>first</strong></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                                        <span class="k">if</span> <span class="n">graph</span> <span class="ow">and</span> <span class="n">graph</span><span class="o">.</span><span class="n">leaf_nodes</span><span class="p">(</span><span class="n">dep</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                                            <span class="n">operation_dependencies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">leaf_nodes</span><span class="p">(</span><span class="n">dep</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">operation_dependencies</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">dep</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;__first__&quot;</span><span class="p">))</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">deps_satisfied</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">deps_satisfied</span><span class="p">:</span>
                        <span class="n">chopped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span>
                        <span class="n">dependencies</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">operation_dependencies</span><span class="p">)</span>
                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">generated_operations</span><span class="p">[</span><span class="n">app_label</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <p>Make a migration! Well, only if there's stuff to put in it</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">if</span> <span class="n">dependencies</span> <span class="ow">or</span> <span class="n">chopped</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">generated_operations</span><span class="p">[</span><span class="n">app_label</span><span class="p">]</span> <span class="ow">or</span> <span class="n">chop_mode</span><span class="p">:</span>
                        <span class="n">subclass</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s2">&quot;Migration&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">Migration</span><span class="p">,),</span> <span class="p">{</span><span class="s2">&quot;operations&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">[]})</span>
                        <span class="n">instance</span> <span class="o">=</span> <span class="n">subclass</span><span class="p">(</span><span class="s2">&quot;auto_</span><span class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">migrations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="p">[]))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">app_label</span><span class="p">)</span>
                        <span class="n">instance</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dependencies</span><span class="p">)</span>
                        <span class="n">instance</span><span class="o">.</span><span class="n">operations</span> <span class="o">=</span> <span class="n">chopped</span>
                        <span class="n">instance</span><span class="o">.</span><span class="n">initial</span> <span class="o">=</span> <span class="n">app_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">existing_apps</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">migrations</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
                        <span class="n">chop_mode</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">generated_operations</span><span class="p">[</span><span class="n">app_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">chopped</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">generated_operations</span><span class="p">[</span><span class="n">app_label</span><span class="p">]</span>
            <span class="n">new_num_ops</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">generated_operations</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">new_num_ops</span> <span class="o">==</span> <span class="n">num_ops</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">chop_mode</span><span class="p">:</span>
                    <span class="n">chop_mode</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot resolve operation dependencies: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">generated_operations</span><span class="p">)</span>
            <span class="n">num_ops</span> <span class="o">=</span> <span class="n">new_num_ops</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>Reorder to make things possible. Reordering may be needed so FKs work
nicely inside the same app.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_sort_migrations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">ops</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generated_operations</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>construct a dependency graph for intra-app dependencies</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">dependency_graph</span> <span class="o">=</span> <span class="p">{</span><span class="n">op</span><span class="p">:</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">_auto_deps</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>Resolve intra-app dependencies to handle circular
references involving a swappable model.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="n">dep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_dependency</span><span class="p">(</span><span class="n">dep</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">dep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">app_label</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">op2</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_dependency</span><span class="p">(</span><span class="n">op2</span><span class="p">,</span> <span class="n">dep</span><span class="p">):</span>
                                <span class="n">dependency_graph</span><span class="p">[</span><span class="n">op</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">op2</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p>we use a stable sort for deterministic tests &amp; general behavior</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">generated_operations</span><span class="p">[</span><span class="n">app_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">stable_topological_sort</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span> <span class="n">dependency_graph</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_optimize_migrations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>Add in internal dependencies among the migrations</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">migrations</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">migrations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">migrations</span><span class="p">,</span> <span class="n">migrations</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="n">m2</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">app_label</span><span class="p">,</span> <span class="n">m1</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      <p>De-dupe dependencies</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">migrations</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">migrations</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">migration</span> <span class="ow">in</span> <span class="n">migrations</span><span class="p">:</span>
                <span class="n">migration</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">migration</span><span class="o">.</span><span class="n">dependencies</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <p>Optimize migrations</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">migrations</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">migrations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">migration</span> <span class="ow">in</span> <span class="n">migrations</span><span class="p">:</span>
                <span class="n">migration</span><span class="o">.</span><span class="n">operations</span> <span class="o">=</span> <span class="n">MigrationOptimizer</span><span class="p">()</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">migration</span><span class="o">.</span><span class="n">operations</span><span class="p">,</span> <span class="n">app_label</span><span class="o">=</span><span class="n">app_label</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      <p>Return True if the given operation depends on the given dependency,
False otherwise.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">check_dependency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">dependency</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <p>Created model</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">operations</span><span class="o">.</span><span class="n">CreateModel</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">operation</span><span class="o">.</span><span class="n">name_lower</span> <span class="o">==</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      <p>Created field</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">elif</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="p">(</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">operations</span><span class="o">.</span><span class="n">CreateModel</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">operation</span><span class="o">.</span><span class="n">name_lower</span> <span class="o">==</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span>
                    <span class="nb">any</span><span class="p">(</span><span class="n">dependency</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">operation</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
                <span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">operations</span><span class="o">.</span><span class="n">AddField</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="n">operation</span><span class="o">.</span><span class="n">model_name_lower</span> <span class="o">==</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span>
                    <span class="n">operation</span><span class="o">.</span><span class="n">name_lower</span> <span class="o">==</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      <p>Removed field</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">elif</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">operations</span><span class="o">.</span><span class="n">RemoveField</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">operation</span><span class="o">.</span><span class="n">model_name_lower</span> <span class="o">==</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span>
                <span class="n">operation</span><span class="o">.</span><span class="n">name_lower</span> <span class="o">==</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      <p>Removed model</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">elif</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">operations</span><span class="o">.</span><span class="n">DeleteModel</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">operation</span><span class="o">.</span><span class="n">name_lower</span> <span class="o">==</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      <p>Field being altered</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">elif</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;alter&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">operations</span><span class="o">.</span><span class="n">AlterField</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">operation</span><span class="o">.</span><span class="n">model_name_lower</span> <span class="o">==</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span>
                <span class="n">operation</span><span class="o">.</span><span class="n">name_lower</span> <span class="o">==</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      <p>order_with_respect_to being unset for a field</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">elif</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;order_wrt_unset&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">operations</span><span class="o">.</span><span class="n">AlterOrderWithRespectTo</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">operation</span><span class="o">.</span><span class="n">name_lower</span> <span class="o">==</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">and</span>
                <span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">order_with_respect_to</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      <p>Field is removed and part of an index/unique_together</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">elif</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;foo_together_change&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="p">(</span><span class="n">operations</span><span class="o">.</span><span class="n">AlterUniqueTogether</span><span class="p">,</span>
                                       <span class="n">operations</span><span class="o">.</span><span class="n">AlterIndexTogether</span><span class="p">))</span> <span class="ow">and</span>
                <span class="n">operation</span><span class="o">.</span><span class="n">name_lower</span> <span class="o">==</span> <span class="n">dependency</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      <p>Unknown dependency. Raise an error.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t handle dependency </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dependency</span><span class="p">,))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">add_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beginning</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      <p>Dependencies are (app_label, model_name, field_name, create/delete as True/False)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">operation</span><span class="o">.</span><span class="n">_auto_deps</span> <span class="o">=</span> <span class="n">dependencies</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">beginning</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generated_operations</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generated_operations</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-55'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-55'>#</a>
      </div>
      <p>Place potential swappable models first in lists of created models (only
real way to solve #22783).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">swappable_first_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-56'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-56'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">base_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">base</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">]</span>
            <span class="n">string_version</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">swappable</span> <span class="ow">or</span>
                <span class="s2">&quot;AbstractUser&quot;</span> <span class="ow">in</span> <span class="n">base_names</span> <span class="ow">or</span>
                <span class="s2">&quot;AbstractBaseUser&quot;</span> <span class="ow">in</span> <span class="n">base_names</span> <span class="ow">or</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">string_version</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;___&quot;</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;___&quot;</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">item</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-57'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-57'>#</a>
      </div>
      <p>Find any renamed models, generate the operations for them, and remove
the old entry from the model lists. Must be run before other
model-level generation.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">generate_renamed_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-58'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-58'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">renamed_models</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renamed_models_rel</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">added_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_model_keys</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_model_keys</span>
        <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">added_models</span><span class="p">):</span>
            <span class="n">model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">]</span>
            <span class="n">model_fields_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">only_relation_agnostic_fields</span><span class="p">(</span><span class="n">model_state</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>

            <span class="n">removed_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_model_keys</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_model_keys</span>
            <span class="k">for</span> <span class="n">rem_app_label</span><span class="p">,</span> <span class="n">rem_model_name</span> <span class="ow">in</span> <span class="n">removed_models</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rem_app_label</span> <span class="o">==</span> <span class="n">app_label</span><span class="p">:</span>
                    <span class="n">rem_model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">rem_app_label</span><span class="p">,</span> <span class="n">rem_model_name</span><span class="p">]</span>
                    <span class="n">rem_model_fields_def</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">only_relation_agnostic_fields</span><span class="p">(</span><span class="n">rem_model_state</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">model_fields_def</span> <span class="o">==</span> <span class="n">rem_model_fields_def</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">questioner</span><span class="o">.</span><span class="n">ask_rename_model</span><span class="p">(</span><span class="n">rem_model_state</span><span class="p">,</span> <span class="n">model_state</span><span class="p">):</span>
                            <span class="n">model_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span><span class="o">.</span><span class="n">_meta</span>
                            <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">model_opts</span><span class="o">.</span><span class="n">get_fields</span><span class="p">():</span>
                                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">is_relation</span><span class="p">:</span>
                                    <span class="n">dependencies</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_dependencies_for_foreign_key</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                                <span class="n">app_label</span><span class="p">,</span>
                                <span class="n">operations</span><span class="o">.</span><span class="n">RenameModel</span><span class="p">(</span>
                                    <span class="n">old_name</span><span class="o">=</span><span class="n">rem_model_state</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                    <span class="n">new_name</span><span class="o">=</span><span class="n">model_state</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                <span class="p">),</span>
                                <span class="n">dependencies</span><span class="o">=</span><span class="n">dependencies</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">renamed_models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rem_model_name</span>
                            <span class="n">renamed_models_rel_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rem_model_state</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span> <span class="n">rem_model_state</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">renamed_models_rel</span><span class="p">[</span><span class="n">renamed_models_rel_key</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">model_state</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span>
                                <span class="n">model_state</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">old_model_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">rem_app_label</span><span class="p">,</span> <span class="n">rem_model_name</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">old_model_keys</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">))</span>
                            <span class="k">break</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-59'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-59'>#</a>
      </div>
      <p>Find all new models (both managed and unmanaged) and make create
operations for them as well as separate operations to create any
foreign key or M2M relationships (these are optimized later, if
possible).</p>
<p>Defer any model options that refer to collections of fields that might
be deferred (e.g. unique_together, index_together).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">generate_created_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-60'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-60'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">old_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_model_keys</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_unmanaged_keys</span>
        <span class="n">added_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_model_keys</span> <span class="o">-</span> <span class="n">old_keys</span>
        <span class="n">added_unmanaged_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_unmanaged_keys</span> <span class="o">-</span> <span class="n">old_keys</span>
        <span class="n">all_added_models</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span>
            <span class="nb">sorted</span><span class="p">(</span><span class="n">added_models</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">swappable_first_key</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="nb">sorted</span><span class="p">(</span><span class="n">added_unmanaged_models</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">swappable_first_key</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">all_added_models</span><span class="p">:</span>
            <span class="n">model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">]</span>
            <span class="n">model_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span><span class="o">.</span><span class="n">_meta</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-61'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-61'>#</a>
      </div>
      <p>Gather related fields</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">related_fields</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">primary_key_rel</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">model_opts</span><span class="o">.</span><span class="n">local_fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
                            <span class="n">primary_key_rel</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span>
                        <span class="k">elif</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">parent_link</span><span class="p">:</span>
                            <span class="n">related_fields</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-62'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-62'>#</a>
      </div>
      <p>through will be none on M2Ms on swapped-out models;
we can treat lack of through as auto_created=True, though.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="p">,</span> <span class="s2">&quot;through&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">auto_created</span><span class="p">):</span>
                        <span class="n">related_fields</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">model_opts</span><span class="o">.</span><span class="n">local_many_to_many</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
                    <span class="n">related_fields</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="p">,</span> <span class="s2">&quot;through&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">auto_created</span><span class="p">:</span>
                    <span class="n">related_fields</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-63'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-63'>#</a>
      </div>
      <p>Are there indexes/unique|index_together to defer?</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">indexes</span> <span class="o">=</span> <span class="n">model_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;indexes&#39;</span><span class="p">)</span>
            <span class="n">constraints</span> <span class="o">=</span> <span class="n">model_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;constraints&#39;</span><span class="p">)</span>
            <span class="n">unique_together</span> <span class="o">=</span> <span class="n">model_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;unique_together&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">index_together</span> <span class="o">=</span> <span class="n">model_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;index_together&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">order_with_respect_to</span> <span class="o">=</span> <span class="n">model_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;order_with_respect_to&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-64'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-64'>#</a>
      </div>
      <p>Depend on the deletion of any possible proxy version of us</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-65'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-65'>#</a>
      </div>
      <p>Depend on all bases</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">model_state</span><span class="o">.</span><span class="n">bases</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">base</span><span class="p">:</span>
                    <span class="n">base_app_label</span><span class="p">,</span> <span class="n">base_name</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">base_app_label</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-66'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-66'>#</a>
      </div>
      <p>Depend on the other end of the primary key if it's a relation</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="n">primary_key_rel</span><span class="p">:</span>
                <span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                    <span class="n">primary_key_rel</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span>
                    <span class="n">primary_key_rel</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="kc">True</span>
                <span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-67'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-67'>#</a>
      </div>
      <p>Generate creation operation</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                <span class="n">app_label</span><span class="p">,</span>
                <span class="n">operations</span><span class="o">.</span><span class="n">CreateModel</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">model_state</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">model_state</span><span class="o">.</span><span class="n">fields</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">related_fields</span><span class="p">],</span>
                    <span class="n">options</span><span class="o">=</span><span class="n">model_state</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                    <span class="n">bases</span><span class="o">=</span><span class="n">model_state</span><span class="o">.</span><span class="n">bases</span><span class="p">,</span>
                    <span class="n">managers</span><span class="o">=</span><span class="n">model_state</span><span class="o">.</span><span class="n">managers</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">dependencies</span><span class="o">=</span><span class="n">dependencies</span><span class="p">,</span>
                <span class="n">beginning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-68'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-68'>#</a>
      </div>
      <p>Don't add operations which modify the database for unmanaged models</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="ow">not</span> <span class="n">model_opts</span><span class="o">.</span><span class="n">managed</span><span class="p">:</span>
                <span class="k">continue</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-69'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-69'>#</a>
      </div>
      <p>Generate operations for each related field</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">related_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dependencies_for_foreign_key</span><span class="p">(</span><span class="n">field</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-70'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-70'>#</a>
      </div>
      <p>Depend on our own model being created</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-71'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-71'>#</a>
      </div>
      <p>Make operation</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                    <span class="n">app_label</span><span class="p">,</span>
                    <span class="n">operations</span><span class="o">.</span><span class="n">AddField</span><span class="p">(</span>
                        <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">dependencies</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dependencies</span><span class="p">)),</span>
                <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-72'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-72'>#</a>
      </div>
      <p>Generate other opns</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">related_dependencies</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">related_fields</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">related_dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                    <span class="n">app_label</span><span class="p">,</span>
                    <span class="n">operations</span><span class="o">.</span><span class="n">AddIndex</span><span class="p">(</span>
                        <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                        <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">dependencies</span><span class="o">=</span><span class="n">related_dependencies</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                    <span class="n">app_label</span><span class="p">,</span>
                    <span class="n">operations</span><span class="o">.</span><span class="n">AddConstraint</span><span class="p">(</span>
                        <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                        <span class="n">constraint</span><span class="o">=</span><span class="n">constraint</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">dependencies</span><span class="o">=</span><span class="n">related_dependencies</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">unique_together</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                    <span class="n">app_label</span><span class="p">,</span>
                    <span class="n">operations</span><span class="o">.</span><span class="n">AlterUniqueTogether</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                        <span class="n">unique_together</span><span class="o">=</span><span class="n">unique_together</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">dependencies</span><span class="o">=</span><span class="n">related_dependencies</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">index_together</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                    <span class="n">app_label</span><span class="p">,</span>
                    <span class="n">operations</span><span class="o">.</span><span class="n">AlterIndexTogether</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                        <span class="n">index_together</span><span class="o">=</span><span class="n">index_together</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">dependencies</span><span class="o">=</span><span class="n">related_dependencies</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">order_with_respect_to</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                    <span class="n">app_label</span><span class="p">,</span>
                    <span class="n">operations</span><span class="o">.</span><span class="n">AlterOrderWithRespectTo</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                        <span class="n">order_with_respect_to</span><span class="o">=</span><span class="n">order_with_respect_to</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span>
                        <span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">order_with_respect_to</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                    <span class="p">]</span>
                <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-73'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-73'>#</a>
      </div>
      <p>Fix relationships if the model changed from a proxy model to a
concrete model.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_proxy_keys</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">related_object</span> <span class="ow">in</span> <span class="n">model_opts</span><span class="o">.</span><span class="n">related_objects</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                        <span class="n">related_object</span><span class="o">.</span><span class="n">related_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span>
                        <span class="n">operations</span><span class="o">.</span><span class="n">AlterField</span><span class="p">(</span>
                            <span class="n">model_name</span><span class="o">=</span><span class="n">related_object</span><span class="o">.</span><span class="n">related_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">related_object</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">field</span><span class="o">=</span><span class="n">related_object</span><span class="o">.</span><span class="n">field</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">dependencies</span><span class="o">=</span><span class="p">[(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)],</span>
                    <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-74'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-74'>#</a>
      </div>
      <p>Make CreateModel statements for proxy models. Use the same statements
as that way there's less code duplication, but of course for proxy
models it's safe to skip all the pointless field stuff and just chuck
out an operation.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">generate_created_proxies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-75'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-75'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">added</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_proxy_keys</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_proxy_keys</span>
        <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">added</span><span class="p">):</span>
            <span class="n">model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">model_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;proxy&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-76'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-76'>#</a>
      </div>
      <p>Depend on the deletion of any possible non-proxy version of us</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-77'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-77'>#</a>
      </div>
      <p>Depend on all bases</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">model_state</span><span class="o">.</span><span class="n">bases</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">base</span><span class="p">:</span>
                    <span class="n">base_app_label</span><span class="p">,</span> <span class="n">base_name</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">base_app_label</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-78'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-78'>#</a>
      </div>
      <p>Generate creation operation</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                <span class="n">app_label</span><span class="p">,</span>
                <span class="n">operations</span><span class="o">.</span><span class="n">CreateModel</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">model_state</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">fields</span><span class="o">=</span><span class="p">[],</span>
                    <span class="n">options</span><span class="o">=</span><span class="n">model_state</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                    <span class="n">bases</span><span class="o">=</span><span class="n">model_state</span><span class="o">.</span><span class="n">bases</span><span class="p">,</span>
                    <span class="n">managers</span><span class="o">=</span><span class="n">model_state</span><span class="o">.</span><span class="n">managers</span><span class="p">,</span>
                <span class="p">),</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-79'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-79'>#</a>
      </div>
      <p>Depend on the deletion of any possible non-proxy version of us</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">dependencies</span><span class="o">=</span><span class="n">dependencies</span><span class="p">,</span>
            <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-80'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-80'>#</a>
      </div>
      <p>Find all deleted models (managed and unmanaged) and make delete
operations for them as well as separate operations to delete any
foreign key or M2M relationships (these are optimized later, if
possible).</p>
<p>Also bring forward removal of any model options that refer to
collections of fields - the inverse of generate_created_models().</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">generate_deleted_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-81'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-81'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">new_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_model_keys</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_unmanaged_keys</span>
        <span class="n">deleted_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_model_keys</span> <span class="o">-</span> <span class="n">new_keys</span>
        <span class="n">deleted_unmanaged_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_unmanaged_keys</span> <span class="o">-</span> <span class="n">new_keys</span>
        <span class="n">all_deleted_models</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">deleted_models</span><span class="p">),</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">deleted_unmanaged_models</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">all_deleted_models</span><span class="p">:</span>
            <span class="n">model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">]</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-82'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-82'>#</a>
      </div>
      <p>Gather related fields</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">related_fields</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">local_fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
                        <span class="n">related_fields</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-83'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-83'>#</a>
      </div>
      <p>through will be none on M2Ms on swapped-out models;
we can treat lack of through as auto_created=True, though.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="k">if</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="p">,</span> <span class="s2">&quot;through&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">auto_created</span><span class="p">):</span>
                        <span class="n">related_fields</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">local_many_to_many</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
                    <span class="n">related_fields</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="p">,</span> <span class="s2">&quot;through&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">auto_created</span><span class="p">:</span>
                    <span class="n">related_fields</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-84'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-84'>#</a>
      </div>
      <p>Generate option removal first</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">unique_together</span> <span class="o">=</span> <span class="n">model_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;unique_together&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">index_together</span> <span class="o">=</span> <span class="n">model_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;index_together&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unique_together</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                    <span class="n">app_label</span><span class="p">,</span>
                    <span class="n">operations</span><span class="o">.</span><span class="n">AlterUniqueTogether</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                        <span class="n">unique_together</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">index_together</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                    <span class="n">app_label</span><span class="p">,</span>
                    <span class="n">operations</span><span class="o">.</span><span class="n">AlterIndexTogether</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                        <span class="n">index_together</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-85'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-85'>#</a>
      </div>
      <p>Then remove each related field</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">related_fields</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                    <span class="n">app_label</span><span class="p">,</span>
                    <span class="n">operations</span><span class="o">.</span><span class="n">RemoveField</span><span class="p">(</span>
                        <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-86'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-86'>#</a>
      </div>
      <p>Finally, remove the model.
This depends on both the removal/alteration of all incoming fields
and the removal of all its own related fields, and if it's
a through model the field that references it.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">related_object</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">related_objects</span><span class="p">:</span>
                <span class="n">related_object_app_label</span> <span class="o">=</span> <span class="n">related_object</span><span class="o">.</span><span class="n">related_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span>
                <span class="n">object_name</span> <span class="o">=</span> <span class="n">related_object</span><span class="o">.</span><span class="n">related_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span>
                <span class="n">field_name</span> <span class="o">=</span> <span class="n">related_object</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">name</span>
                <span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">related_object_app_label</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">related_object</span><span class="o">.</span><span class="n">many_to_many</span><span class="p">:</span>
                    <span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">related_object_app_label</span><span class="p">,</span> <span class="n">object_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="s2">&quot;alter&quot;</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">related_fields</span><span class="p">):</span>
                <span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-87'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-87'>#</a>
      </div>
      <p>We're referenced in another field's through=</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">through_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">through_users</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_state</span><span class="o">.</span><span class="n">name_lower</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">through_user</span><span class="p">:</span>
                <span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">through_user</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">through_user</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">through_user</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="kc">False</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-88'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-88'>#</a>
      </div>
      <p>Finally, make the operation, deduping any dependencies</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                <span class="n">app_label</span><span class="p">,</span>
                <span class="n">operations</span><span class="o">.</span><span class="n">DeleteModel</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">model_state</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">dependencies</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dependencies</span><span class="p">)),</span>
            <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-89'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-89'>#</a>
      </div>
      <p>Make DeleteModel options for proxy models.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">generate_deleted_proxies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-90'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-90'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">deleted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_proxy_keys</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_proxy_keys</span>
        <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">deleted</span><span class="p">):</span>
            <span class="n">model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">model_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;proxy&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                <span class="n">app_label</span><span class="p">,</span>
                <span class="n">operations</span><span class="o">.</span><span class="n">DeleteModel</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">model_state</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-91'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-91'>#</a>
      </div>
      <p>Work out renamed fields.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">generate_renamed_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-92'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-92'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">renamed_fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_field_keys</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_field_keys</span><span class="p">):</span>
            <span class="n">old_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renamed_models</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">),</span> <span class="n">model_name</span><span class="p">)</span>
            <span class="n">old_model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">old_model_name</span><span class="p">]</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-93'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-93'>#</a>
      </div>
      <p>Scan to see if this is actually a rename!</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">field_dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deep_deconstruct</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rem_app_label</span><span class="p">,</span> <span class="n">rem_model_name</span><span class="p">,</span> <span class="n">rem_field_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_field_keys</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_field_keys</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">rem_app_label</span> <span class="o">==</span> <span class="n">app_label</span> <span class="ow">and</span> <span class="n">rem_model_name</span> <span class="o">==</span> <span class="n">model_name</span><span class="p">:</span>
                    <span class="n">old_field</span> <span class="o">=</span> <span class="n">old_model_state</span><span class="o">.</span><span class="n">get_field_by_name</span><span class="p">(</span><span class="n">rem_field_name</span><span class="p">)</span>
                    <span class="n">old_field_dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deep_deconstruct</span><span class="p">(</span><span class="n">old_field</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span> <span class="ow">and</span> <span class="s1">&#39;to&#39;</span> <span class="ow">in</span> <span class="n">old_field_dec</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="n">old_rel_to</span> <span class="o">=</span> <span class="n">old_field_dec</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;to&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">old_rel_to</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">renamed_models_rel</span><span class="p">:</span>
                            <span class="n">old_field_dec</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renamed_models_rel</span><span class="p">[</span><span class="n">old_rel_to</span><span class="p">]</span>
                    <span class="n">old_field</span><span class="o">.</span><span class="n">set_attributes_from_name</span><span class="p">(</span><span class="n">rem_field_name</span><span class="p">)</span>
                    <span class="n">old_db_column</span> <span class="o">=</span> <span class="n">old_field</span><span class="o">.</span><span class="n">get_attname_column</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">old_field_dec</span> <span class="o">==</span> <span class="n">field_dec</span> <span class="ow">or</span> <span class="p">(</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-94'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-94'>#</a>
      </div>
      <p>Was the field renamed and db_column equal to the
old field's column added?</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                            <span class="n">old_field_dec</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">field_dec</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span>
                            <span class="nb">dict</span><span class="p">(</span><span class="n">old_field_dec</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">db_column</span><span class="o">=</span><span class="n">old_db_column</span><span class="p">)</span> <span class="o">==</span> <span class="n">field_dec</span><span class="p">[</span><span class="mi">2</span><span class="p">])):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">questioner</span><span class="o">.</span><span class="n">ask_rename</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">rem_field_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                                <span class="n">app_label</span><span class="p">,</span>
                                <span class="n">operations</span><span class="o">.</span><span class="n">RenameField</span><span class="p">(</span>
                                    <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                                    <span class="n">old_name</span><span class="o">=</span><span class="n">rem_field_name</span><span class="p">,</span>
                                    <span class="n">new_name</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">old_field_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">rem_app_label</span><span class="p">,</span> <span class="n">rem_model_name</span><span class="p">,</span> <span class="n">rem_field_name</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">old_field_keys</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">renamed_fields</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rem_field_name</span>
                            <span class="k">break</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-95'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-95'>#</a>
      </div>
      <p>Make AddField operations.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">generate_added_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-96'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-96'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_field_keys</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_field_keys</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_added_field</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-97'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-97'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_generate_added_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-98'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-98'>#</a>
      </div>
      <p>Fields that are foreignkeys/m2ms depend on stuff</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
            <span class="n">dependencies</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_dependencies_for_foreign_key</span><span class="p">(</span><span class="n">field</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-99'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-99'>#</a>
      </div>
      <p>You can't just add NOT NULL fields with no default or fields
which don't allow empty strings as default.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">time_fields</span> <span class="o">=</span> <span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">TimeField</span><span class="p">)</span>
        <span class="n">preserve_default</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">field</span><span class="o">.</span><span class="n">null</span> <span class="ow">or</span> <span class="n">field</span><span class="o">.</span><span class="n">has_default</span><span class="p">()</span> <span class="ow">or</span> <span class="n">field</span><span class="o">.</span><span class="n">many_to_many</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">blank</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">empty_strings_allowed</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">time_fields</span><span class="p">)</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">auto_now</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">preserve_default</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">time_fields</span><span class="p">)</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">auto_now_add</span><span class="p">:</span>
                <span class="n">field</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">questioner</span><span class="o">.</span><span class="n">ask_auto_now_add_addition</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">field</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">questioner</span><span class="o">.</span><span class="n">ask_not_null_addition</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
            <span class="n">app_label</span><span class="p">,</span>
            <span class="n">operations</span><span class="o">.</span><span class="n">AddField</span><span class="p">(</span>
                <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span>
                <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
                <span class="n">preserve_default</span><span class="o">=</span><span class="n">preserve_default</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">dependencies</span><span class="o">=</span><span class="n">dependencies</span><span class="p">,</span>
        <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-100'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-100'>#</a>
      </div>
      <p>Make RemoveField operations.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">generate_removed_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-101'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-101'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_field_keys</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_field_keys</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_removed_field</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-102'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-102'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_generate_removed_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
            <span class="n">app_label</span><span class="p">,</span>
            <span class="n">operations</span><span class="o">.</span><span class="n">RemoveField</span><span class="p">(</span>
                <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span>
            <span class="p">),</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-103'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-103'>#</a>
      </div>
      <p>We might need to depend on the removal of an
order_with_respect_to or index/unique_together operation;
this is safely ignored if there isn't one</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">dependencies</span><span class="o">=</span><span class="p">[</span>
                <span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="s2">&quot;order_wrt_unset&quot;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="s2">&quot;foo_together_change&quot;</span><span class="p">),</span>
            <span class="p">],</span>
        <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-104'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-104'>#</a>
      </div>
      <p>Make AlterField operations, or possibly RemovedField/AddField if alter
isn's possible.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">generate_altered_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-105'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-105'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_field_keys</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_field_keys</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-106'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-106'>#</a>
      </div>
      <p>Did the field change?</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">old_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renamed_models</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">),</span> <span class="n">model_name</span><span class="p">)</span>
            <span class="n">old_field_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renamed_fields</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">),</span> <span class="n">field_name</span><span class="p">)</span>
            <span class="n">old_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">old_model_name</span><span class="p">)</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">old_field_name</span><span class="p">)</span>
            <span class="n">new_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-107'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-107'>#</a>
      </div>
      <p>Implement any model renames on relations; these are handled by RenameModel
so we need to exclude them from the comparison</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">new_field</span><span class="p">,</span> <span class="s2">&quot;remote_field&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">new_field</span><span class="o">.</span><span class="n">remote_field</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">rename_key</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">new_field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span>
                    <span class="n">new_field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">rename_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">renamed_models</span><span class="p">:</span>
                    <span class="n">new_field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">old_field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-108'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-108'>#</a>
      </div>
      <p>Handle ForeignKey which can only have a single to_field.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">remote_field_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">new_field</span><span class="o">.</span><span class="n">remote_field</span><span class="p">,</span> <span class="s1">&#39;field_name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">remote_field_name</span><span class="p">:</span>
                    <span class="n">to_field_rename_key</span> <span class="o">=</span> <span class="n">rename_key</span> <span class="o">+</span> <span class="p">(</span><span class="n">remote_field_name</span><span class="p">,)</span>
                    <span class="k">if</span> <span class="n">to_field_rename_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">renamed_fields</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-109'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-109'>#</a>
      </div>
      <p>Repoint both model and field name because to_field
inclusion in ForeignKey.deconstruct() is based on
both.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                        <span class="n">new_field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">old_field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span>
                        <span class="n">new_field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">field_name</span> <span class="o">=</span> <span class="n">old_field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">field_name</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-110'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-110'>#</a>
      </div>
      <p>Handle ForeignObjects which can have multiple from_fields/to_fields.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">from_fields</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">new_field</span><span class="p">,</span> <span class="s1">&#39;from_fields&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">from_fields</span><span class="p">:</span>
                    <span class="n">from_rename_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
                    <span class="n">new_field</span><span class="o">.</span><span class="n">from_fields</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">renamed_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">from_rename_key</span> <span class="o">+</span> <span class="p">(</span><span class="n">from_field</span><span class="p">,),</span> <span class="n">from_field</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">from_field</span> <span class="ow">in</span> <span class="n">from_fields</span>
                    <span class="p">])</span>
                    <span class="n">new_field</span><span class="o">.</span><span class="n">to_fields</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">renamed_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rename_key</span> <span class="o">+</span> <span class="p">(</span><span class="n">to_field</span><span class="p">,),</span> <span class="n">to_field</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">to_field</span> <span class="ow">in</span> <span class="n">new_field</span><span class="o">.</span><span class="n">to_fields</span>
                    <span class="p">])</span>
                <span class="n">dependencies</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_dependencies_for_foreign_key</span><span class="p">(</span><span class="n">new_field</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">new_field</span><span class="p">,</span> <span class="s2">&quot;remote_field&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">new_field</span><span class="o">.</span><span class="n">remote_field</span><span class="p">,</span> <span class="s2">&quot;through&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">rename_key</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">new_field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span>
                    <span class="n">new_field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">rename_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">renamed_models</span><span class="p">:</span>
                    <span class="n">new_field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">through</span> <span class="o">=</span> <span class="n">old_field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">through</span>
            <span class="n">old_field_dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deep_deconstruct</span><span class="p">(</span><span class="n">old_field</span><span class="p">)</span>
            <span class="n">new_field_dec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deep_deconstruct</span><span class="p">(</span><span class="n">new_field</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old_field_dec</span> <span class="o">!=</span> <span class="n">new_field_dec</span><span class="p">:</span>
                <span class="n">both_m2m</span> <span class="o">=</span> <span class="n">old_field</span><span class="o">.</span><span class="n">many_to_many</span> <span class="ow">and</span> <span class="n">new_field</span><span class="o">.</span><span class="n">many_to_many</span>
                <span class="n">neither_m2m</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">old_field</span><span class="o">.</span><span class="n">many_to_many</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new_field</span><span class="o">.</span><span class="n">many_to_many</span>
                <span class="k">if</span> <span class="n">both_m2m</span> <span class="ow">or</span> <span class="n">neither_m2m</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-111'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-111'>#</a>
      </div>
      <p>Either both fields are m2m or neither is</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="n">preserve_default</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">old_field</span><span class="o">.</span><span class="n">null</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new_field</span><span class="o">.</span><span class="n">null</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new_field</span><span class="o">.</span><span class="n">has_default</span><span class="p">()</span> <span class="ow">and</span>
                            <span class="ow">not</span> <span class="n">new_field</span><span class="o">.</span><span class="n">many_to_many</span><span class="p">):</span>
                        <span class="n">field</span> <span class="o">=</span> <span class="n">new_field</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                        <span class="n">new_default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">questioner</span><span class="o">.</span><span class="n">ask_not_null_alteration</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">new_default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">models</span><span class="o">.</span><span class="n">NOT_PROVIDED</span><span class="p">:</span>
                            <span class="n">field</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">new_default</span>
                            <span class="n">preserve_default</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">field</span> <span class="o">=</span> <span class="n">new_field</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                        <span class="n">app_label</span><span class="p">,</span>
                        <span class="n">operations</span><span class="o">.</span><span class="n">AlterField</span><span class="p">(</span>
                            <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                            <span class="n">name</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span>
                            <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
                            <span class="n">preserve_default</span><span class="o">=</span><span class="n">preserve_default</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">dependencies</span><span class="o">=</span><span class="n">dependencies</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-112'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-112'>#</a>
      </div>
      <p>We cannot alter between m2m and concrete fields</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="bp">self</span><span class="o">.</span><span class="n">_generate_removed_field</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_generate_added_field</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-113'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-113'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">create_altered_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">option_name</span> <span class="o">=</span> <span class="n">operations</span><span class="o">.</span><span class="n">AddIndex</span><span class="o">.</span><span class="n">option_name</span>
        <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kept_model_keys</span><span class="p">):</span>
            <span class="n">old_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renamed_models</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">),</span> <span class="n">model_name</span><span class="p">)</span>
            <span class="n">old_model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">old_model_name</span><span class="p">]</span>
            <span class="n">new_model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">]</span>

            <span class="n">old_indexes</span> <span class="o">=</span> <span class="n">old_model_state</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">option_name</span><span class="p">]</span>
            <span class="n">new_indexes</span> <span class="o">=</span> <span class="n">new_model_state</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">option_name</span><span class="p">]</span>
            <span class="n">add_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">new_indexes</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">old_indexes</span><span class="p">]</span>
            <span class="n">rem_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">old_indexes</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_indexes</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">altered_indexes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span> <span class="p">{</span>
                    <span class="s1">&#39;added_indexes&#39;</span><span class="p">:</span> <span class="n">add_idx</span><span class="p">,</span> <span class="s1">&#39;removed_indexes&#39;</span><span class="p">:</span> <span class="n">rem_idx</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">})</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-114'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-114'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">generate_added_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">),</span> <span class="n">alt_indexes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">altered_indexes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">alt_indexes</span><span class="p">[</span><span class="s1">&#39;added_indexes&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                    <span class="n">app_label</span><span class="p">,</span>
                    <span class="n">operations</span><span class="o">.</span><span class="n">AddIndex</span><span class="p">(</span>
                        <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                        <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-115'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-115'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">generate_removed_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">),</span> <span class="n">alt_indexes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">altered_indexes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">alt_indexes</span><span class="p">[</span><span class="s1">&#39;removed_indexes&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                    <span class="n">app_label</span><span class="p">,</span>
                    <span class="n">operations</span><span class="o">.</span><span class="n">RemoveIndex</span><span class="p">(</span>
                        <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-116'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-116'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">create_altered_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">option_name</span> <span class="o">=</span> <span class="n">operations</span><span class="o">.</span><span class="n">AddConstraint</span><span class="o">.</span><span class="n">option_name</span>
        <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kept_model_keys</span><span class="p">):</span>
            <span class="n">old_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renamed_models</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">),</span> <span class="n">model_name</span><span class="p">)</span>
            <span class="n">old_model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">old_model_name</span><span class="p">]</span>
            <span class="n">new_model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">]</span>

            <span class="n">old_constraints</span> <span class="o">=</span> <span class="n">old_model_state</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">option_name</span><span class="p">]</span>
            <span class="n">new_constraints</span> <span class="o">=</span> <span class="n">new_model_state</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">option_name</span><span class="p">]</span>
            <span class="n">add_constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">new_constraints</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">old_constraints</span><span class="p">]</span>
            <span class="n">rem_constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">old_constraints</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_constraints</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">altered_constraints</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span> <span class="p">{</span>
                    <span class="s1">&#39;added_constraints&#39;</span><span class="p">:</span> <span class="n">add_constraints</span><span class="p">,</span> <span class="s1">&#39;removed_constraints&#39;</span><span class="p">:</span> <span class="n">rem_constraints</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">})</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-117'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-117'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">generate_added_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">),</span> <span class="n">alt_constraints</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">altered_constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">alt_constraints</span><span class="p">[</span><span class="s1">&#39;added_constraints&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                    <span class="n">app_label</span><span class="p">,</span>
                    <span class="n">operations</span><span class="o">.</span><span class="n">AddConstraint</span><span class="p">(</span>
                        <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                        <span class="n">constraint</span><span class="o">=</span><span class="n">constraint</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-118'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-118'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">generate_removed_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">),</span> <span class="n">alt_constraints</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">altered_constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">alt_constraints</span><span class="p">[</span><span class="s1">&#39;removed_constraints&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                    <span class="n">app_label</span><span class="p">,</span>
                    <span class="n">operations</span><span class="o">.</span><span class="n">RemoveConstraint</span><span class="p">(</span>
                        <span class="n">model_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">constraint</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-119'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-119'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_get_dependencies_for_foreign_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-120'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-120'>#</a>
      </div>
      <p>Account for FKs to swappable models</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">swappable_setting</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;swappable_setting&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">swappable_setting</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dep_app_label</span> <span class="o">=</span> <span class="s2">&quot;__setting__&quot;</span>
            <span class="n">dep_object_name</span> <span class="o">=</span> <span class="n">swappable_setting</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dep_app_label</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span>
            <span class="n">dep_object_name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[(</span><span class="n">dep_app_label</span><span class="p">,</span> <span class="n">dep_object_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="p">,</span> <span class="s2">&quot;through&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">auto_created</span><span class="p">:</span>
            <span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span>
                <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="kc">True</span><span class="p">,</span>
            <span class="p">))</span>
        <span class="k">return</span> <span class="n">dependencies</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-121'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-121'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_generate_altered_foo_together</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">):</span>
        <span class="n">option_name</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">option_name</span>
        <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kept_model_keys</span><span class="p">):</span>
            <span class="n">old_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renamed_models</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">),</span> <span class="n">model_name</span><span class="p">)</span>
            <span class="n">old_model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">old_model_name</span><span class="p">]</span>
            <span class="n">new_model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-122'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-122'>#</a>
      </div>
      <p>We run the old version through the field renames to account for those</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">old_value</span> <span class="o">=</span> <span class="n">old_model_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">option_name</span><span class="p">)</span>
            <span class="n">old_value</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nb">tuple</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">renamed_fields</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">n</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">unique</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">unique</span> <span class="ow">in</span> <span class="n">old_value</span>
            <span class="p">}</span> <span class="k">if</span> <span class="n">old_value</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>

            <span class="n">new_value</span> <span class="o">=</span> <span class="n">new_model_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">option_name</span><span class="p">)</span>
            <span class="n">new_value</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span> <span class="k">if</span> <span class="n">new_value</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">old_value</span> <span class="o">!=</span> <span class="n">new_value</span><span class="p">:</span>
                <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">foo_togethers</span> <span class="ow">in</span> <span class="n">new_value</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">foo_togethers</span><span class="p">:</span>
                        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_apps</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">remote_field</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
                            <span class="n">dependencies</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_dependencies_for_foreign_key</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                    <span class="n">app_label</span><span class="p">,</span>
                    <span class="n">operation</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                        <span class="o">**</span><span class="p">{</span><span class="n">option_name</span><span class="p">:</span> <span class="n">new_value</span><span class="p">}</span>
                    <span class="p">),</span>
                    <span class="n">dependencies</span><span class="o">=</span><span class="n">dependencies</span><span class="p">,</span>
                <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-123'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-123'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">generate_altered_unique_together</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_altered_foo_together</span><span class="p">(</span><span class="n">operations</span><span class="o">.</span><span class="n">AlterUniqueTogether</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-124'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-124'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">generate_altered_index_together</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_altered_foo_together</span><span class="p">(</span><span class="n">operations</span><span class="o">.</span><span class="n">AlterIndexTogether</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-125'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-125'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">generate_altered_db_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">models_to_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kept_model_keys</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kept_proxy_keys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kept_unmanaged_keys</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">models_to_check</span><span class="p">):</span>
            <span class="n">old_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renamed_models</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">),</span> <span class="n">model_name</span><span class="p">)</span>
            <span class="n">old_model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">old_model_name</span><span class="p">]</span>
            <span class="n">new_model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">]</span>
            <span class="n">old_db_table_name</span> <span class="o">=</span> <span class="n">old_model_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;db_table&#39;</span><span class="p">)</span>
            <span class="n">new_db_table_name</span> <span class="o">=</span> <span class="n">new_model_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;db_table&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old_db_table_name</span> <span class="o">!=</span> <span class="n">new_db_table_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                    <span class="n">app_label</span><span class="p">,</span>
                    <span class="n">operations</span><span class="o">.</span><span class="n">AlterModelTable</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                        <span class="n">table</span><span class="o">=</span><span class="n">new_db_table_name</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-126'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-126'>#</a>
      </div>
      <p>Work out if any non-schema-affecting options have changed and make an
operation to represent them in state changes (in case Python code in
migrations needs them).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">generate_altered_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-127'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-127'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">models_to_check</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kept_model_keys</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kept_proxy_keys</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kept_unmanaged_keys</span><span class="p">,</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-128'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-128'>#</a>
      </div>
      <p>unmanaged converted to managed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">old_unmanaged_keys</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_model_keys</span><span class="p">,</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-129'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-129'>#</a>
      </div>
      <p>managed converted to unmanaged</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">old_model_keys</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_unmanaged_keys</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">models_to_check</span><span class="p">):</span>
            <span class="n">old_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renamed_models</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">),</span> <span class="n">model_name</span><span class="p">)</span>
            <span class="n">old_model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">old_model_name</span><span class="p">]</span>
            <span class="n">new_model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">]</span>
            <span class="n">old_options</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">old_model_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">AlterModelOptions</span><span class="o">.</span><span class="n">ALTER_OPTION_KEYS</span>
            <span class="p">}</span>
            <span class="n">new_options</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">new_model_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">AlterModelOptions</span><span class="o">.</span><span class="n">ALTER_OPTION_KEYS</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">old_options</span> <span class="o">!=</span> <span class="n">new_options</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                    <span class="n">app_label</span><span class="p">,</span>
                    <span class="n">operations</span><span class="o">.</span><span class="n">AlterModelOptions</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                        <span class="n">options</span><span class="o">=</span><span class="n">new_options</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-130'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-130'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">generate_altered_order_with_respect_to</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kept_model_keys</span><span class="p">):</span>
            <span class="n">old_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renamed_models</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">),</span> <span class="n">model_name</span><span class="p">)</span>
            <span class="n">old_model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">old_model_name</span><span class="p">]</span>
            <span class="n">new_model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">old_model_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;order_with_respect_to&quot;</span><span class="p">)</span> <span class="o">!=</span>
                    <span class="n">new_model_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;order_with_respect_to&quot;</span><span class="p">)):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-131'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-131'>#</a>
      </div>
      <p>Make sure it comes second if we're adding
(removal dependency is part of RemoveField)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">new_model_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;order_with_respect_to&quot;</span><span class="p">):</span>
                    <span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                        <span class="n">app_label</span><span class="p">,</span>
                        <span class="n">model_name</span><span class="p">,</span>
                        <span class="n">new_model_state</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;order_with_respect_to&quot;</span><span class="p">],</span>
                        <span class="kc">True</span><span class="p">,</span>
                    <span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-132'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-132'>#</a>
      </div>
      <p>Actually generate the operation</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                    <span class="n">app_label</span><span class="p">,</span>
                    <span class="n">operations</span><span class="o">.</span><span class="n">AlterOrderWithRespectTo</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                        <span class="n">order_with_respect_to</span><span class="o">=</span><span class="n">new_model_state</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order_with_respect_to&#39;</span><span class="p">),</span>
                    <span class="p">),</span>
                    <span class="n">dependencies</span><span class="o">=</span><span class="n">dependencies</span><span class="p">,</span>
                <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-133'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-133'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">generate_altered_managers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kept_model_keys</span><span class="p">):</span>
            <span class="n">old_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renamed_models</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">),</span> <span class="n">model_name</span><span class="p">)</span>
            <span class="n">old_model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">old_model_name</span><span class="p">]</span>
            <span class="n">new_model_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_state</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">old_model_state</span><span class="o">.</span><span class="n">managers</span> <span class="o">!=</span> <span class="n">new_model_state</span><span class="o">.</span><span class="n">managers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_operation</span><span class="p">(</span>
                    <span class="n">app_label</span><span class="p">,</span>
                    <span class="n">operations</span><span class="o">.</span><span class="n">AlterModelManagers</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
                        <span class="n">managers</span><span class="o">=</span><span class="n">new_model_state</span><span class="o">.</span><span class="n">managers</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-134'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-134'>#</a>
      </div>
      <p>Take a result from changes() and a MigrationGraph, and fix the names
and dependencies of the changes so they extend the graph from the leaf
nodes for each app.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">arrange_for_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">changes</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">migration_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-135'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-135'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">leaves</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">leaf_nodes</span><span class="p">()</span>
        <span class="n">name_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">migrations</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">changes</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">migrations</span><span class="p">:</span>
                <span class="k">continue</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-136'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-136'>#</a>
      </div>
      <p>Find the app label's current leaf node</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">app_leaf</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">leaf</span> <span class="ow">in</span> <span class="n">leaves</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">leaf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">app_label</span><span class="p">:</span>
                    <span class="n">app_leaf</span> <span class="o">=</span> <span class="n">leaf</span>
                    <span class="k">break</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-137'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-137'>#</a>
      </div>
      <p>Do they want an initial migration for this app?</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="n">app_leaf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">questioner</span><span class="o">.</span><span class="n">ask_initial</span><span class="p">(</span><span class="n">app_label</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-138'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-138'>#</a>
      </div>
      <p>They don't.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">for</span> <span class="n">migration</span> <span class="ow">in</span> <span class="n">migrations</span><span class="p">:</span>
                    <span class="n">name_map</span><span class="p">[(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">migration</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="s2">&quot;__first__&quot;</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">changes</span><span class="p">[</span><span class="n">app_label</span><span class="p">]</span>
                <span class="k">continue</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-139'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-139'>#</a>
      </div>
      <p>Work out the next number in the sequence</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="n">app_leaf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">next_number</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">next_number</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_number</span><span class="p">(</span><span class="n">app_leaf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-140'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-140'>#</a>
      </div>
      <p>Name each migration</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">migration</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">migrations</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">app_leaf</span><span class="p">:</span>
                    <span class="n">migration</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">app_leaf</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">app_leaf</span><span class="p">:</span>
                    <span class="n">new_name</span> <span class="o">=</span> <span class="s2">&quot;0001_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">migration_name</span> <span class="k">if</span> <span class="n">migration_name</span> <span class="k">else</span> <span class="s2">&quot;0001_initial&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%04i</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">next_number</span><span class="p">,</span>
                        <span class="n">migration_name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">suggest_name</span><span class="p">(</span><span class="n">migration</span><span class="o">.</span><span class="n">operations</span><span class="p">)[:</span><span class="mi">100</span><span class="p">],</span>
                    <span class="p">)</span>
                <span class="n">name_map</span><span class="p">[(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">migration</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
                <span class="n">next_number</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">migration</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">new_name</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-141'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-141'>#</a>
      </div>
      <p>Now fix dependencies</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">migrations</span> <span class="ow">in</span> <span class="n">changes</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">migration</span> <span class="ow">in</span> <span class="n">migrations</span><span class="p">:</span>
                <span class="n">migration</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">=</span> <span class="p">[</span><span class="n">name_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">migration</span><span class="o">.</span><span class="n">dependencies</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">changes</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-142'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-142'>#</a>
      </div>
      <p>Take changes from arrange_for_graph() and set of app labels, and return
a modified set of changes which trims out as many migrations that are
not in app_labels as possible. Note that some other migrations may
still be present as they may be required dependencies.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_trim_to_apps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">changes</span><span class="p">,</span> <span class="n">app_labels</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-143'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-143'>#</a>
      </div>
      <p>Gather other app dependencies in a first pass</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">app_dependencies</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">migrations</span> <span class="ow">in</span> <span class="n">changes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">migration</span> <span class="ow">in</span> <span class="n">migrations</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dep_app_label</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">migration</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
                    <span class="n">app_dependencies</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dep_app_label</span><span class="p">)</span>
        <span class="n">required_apps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">app_labels</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-144'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-144'>#</a>
      </div>
      <p>Keep resolving till there's no change</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">old_required_apps</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="n">old_required_apps</span> <span class="o">!=</span> <span class="n">required_apps</span><span class="p">:</span>
            <span class="n">old_required_apps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">required_apps</span><span class="p">)</span>
            <span class="n">required_apps</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">app_dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="p">())</span> <span class="k">for</span> <span class="n">app_label</span> <span class="ow">in</span> <span class="n">required_apps</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-145'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-145'>#</a>
      </div>
      <p>Remove all migrations that aren't needed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">app_label</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">changes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">app_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">required_apps</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">changes</span><span class="p">[</span><span class="n">app_label</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">changes</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-146'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-146'>#</a>
      </div>
      <p>Given a set of operations, suggest a name for the migration they might
represent. Names are not guaranteed to be unique, but put some effort
into the fallback name to avoid VCS conflicts if possible.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">suggest_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ops</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-147'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-147'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">operations</span><span class="o">.</span><span class="n">CreateModel</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name_lower</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">operations</span><span class="o">.</span><span class="n">DeleteModel</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;delete_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name_lower</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">operations</span><span class="o">.</span><span class="n">AddField</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model_name_lower</span><span class="p">,</span> <span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name_lower</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">operations</span><span class="o">.</span><span class="n">RemoveField</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;remove_</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model_name_lower</span><span class="p">,</span> <span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name_lower</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ops</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">operations</span><span class="o">.</span><span class="n">CreateModel</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">name_lower</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">ops</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;auto_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">get_migration_name_timestamp</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-148'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-148'>#</a>
      </div>
      <p>Given a migration name, try to extract a number from the beginning of
it. If no number is found, return None.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_number</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-149'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-149'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\d+&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">())</span>
        <span class="k">return</span> <span class="kc">None</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
