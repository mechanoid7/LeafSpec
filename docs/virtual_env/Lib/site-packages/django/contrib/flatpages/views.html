<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>views.py</title>
  <link rel="stylesheet" href="..\..\..\..\..\..\pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>views.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib.flatpages.models</span> <span class="kn">import</span> <span class="n">FlatPage</span>
<span class="kn">from</span> <span class="nn">django.contrib.sites.shortcuts</span> <span class="kn">import</span> <span class="n">get_current_site</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">Http404</span><span class="p">,</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">HttpResponsePermanentRedirect</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">loader</span>
<span class="kn">from</span> <span class="nn">django.utils.safestring</span> <span class="kn">import</span> <span class="n">mark_safe</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.csrf</span> <span class="kn">import</span> <span class="n">csrf_protect</span>

<span class="n">DEFAULT_TEMPLATE</span> <span class="o">=</span> <span class="s1">&#39;flatpages/default.html&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>This view is called from FlatpageFallbackMiddleware.process_response
when a 404 is raised, which often means CsrfViewMiddleware.process_view
has not been called even if CsrfViewMiddleware is installed. So we need
to use @csrf_protect, in case the template needs {% csrf_token %}.
However, we can't just wrap this view; if no matching flatpage exists,
or a redirect is required for authentication, the 404 needs to be returned
without any CSRF checks. Therefore, we only
CSRF protect the internal implementation.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Public interface to the flat page view.</p>
<p>Models: <code>flatpages.flatpages</code>
Templates: Uses the template defined by the <code>template_name</code> field,
    or :template:<code>flatpages/default.html</code> if template_name is not defined.
Context:
    flatpage
        <code>flatpages.flatpages</code> object</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">flatpage</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">url</span>
    <span class="n">site_id</span> <span class="o">=</span> <span class="n">get_current_site</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">id</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">FlatPage</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">sites</span><span class="o">=</span><span class="n">site_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Http404</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">APPEND_SLASH</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">FlatPage</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">sites</span><span class="o">=</span><span class="n">site_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HttpResponsePermanentRedirect</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span>
    <span class="k">return</span> <span class="n">render_flatpage</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Internal interface to the flat page view.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@csrf_protect</span>
<span class="k">def</span> <span class="nf">render_flatpage</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>If registration is required for accessing this page, and the user isn't
logged in, redirect to the login page.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">registration_required</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">django.contrib.auth.views</span> <span class="kn">import</span> <span class="n">redirect_to_login</span>
        <span class="k">return</span> <span class="n">redirect_to_login</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">template_name</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">select_template</span><span class="p">((</span><span class="n">f</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span> <span class="n">DEFAULT_TEMPLATE</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">DEFAULT_TEMPLATE</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>To avoid having to always use the "|safe" filter in flatpage templates,
mark the title and content as already safe (since they are raw HTML
content in the first place).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">f</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">mark_safe</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">mark_safe</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">({</span><span class="s1">&#39;flatpage&#39;</span><span class="p">:</span> <span class="n">f</span><span class="p">},</span> <span class="n">request</span><span class="p">))</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
