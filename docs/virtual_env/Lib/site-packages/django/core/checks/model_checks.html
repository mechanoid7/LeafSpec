<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>model_checks.py</title>
  <link rel="stylesheet" href="..\..\..\..\..\..\pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>model_checks.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>

<span class="kn">from</span> <span class="nn">django.apps</span> <span class="kn">import</span> <span class="n">apps</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.core.checks</span> <span class="kn">import</span> <span class="n">Error</span><span class="p">,</span> <span class="n">Tags</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">,</span> <span class="n">register</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>Ensure all lazy (i.e. string) model references have been resolved.</p>
<p>Lazy references are used in various places throughout Django, primarily in
related fields and model signals. Identify those common cases and provide
more helpful error messages for them.</p>
<p>The ignore parameter is used by StateApps to exclude swappable models from
this check.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@register</span><span class="p">(</span><span class="n">Tags</span><span class="o">.</span><span class="n">models</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_all_models</span><span class="p">(</span><span class="n">app_configs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">db_table_models</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">indexes</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">app_configs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">models</span> <span class="o">=</span> <span class="n">apps</span><span class="o">.</span><span class="n">get_models</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">models</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">app_config</span><span class="o">.</span><span class="n">get_models</span><span class="p">()</span> <span class="k">for</span> <span class="n">app_config</span> <span class="ow">in</span> <span class="n">app_configs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">managed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">proxy</span><span class="p">:</span>
            <span class="n">db_table_models</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">check</span><span class="p">):</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Error</span><span class="p">(</span>
                    <span class="s2">&quot;The &#39;</span><span class="si">%s</span><span class="s2">.check()&#39; class method is currently overridden by </span><span class="si">%r</span><span class="s2">.&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">check</span><span class="p">),</span>
                    <span class="n">obj</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                    <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;models.E020&#39;</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">model_index</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">indexes</span><span class="p">:</span>
            <span class="n">indexes</span><span class="p">[</span><span class="n">model_index</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">model_constraint</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
            <span class="n">constraints</span><span class="p">[</span><span class="n">model_constraint</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DATABASE_ROUTERS</span><span class="p">:</span>
        <span class="n">error_class</span><span class="p">,</span> <span class="n">error_id</span> <span class="o">=</span> <span class="ne">Warning</span><span class="p">,</span> <span class="s1">&#39;models.W035&#39;</span>
        <span class="n">error_hint</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;You have configured settings.DATABASE_ROUTERS. Verify that </span><span class="si">%s</span><span class="s1"> &#39;</span>
            <span class="s1">&#39;are correctly routed to separate databases.&#39;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">error_class</span><span class="p">,</span> <span class="n">error_id</span> <span class="o">=</span> <span class="n">Error</span><span class="p">,</span> <span class="s1">&#39;models.E028&#39;</span>
        <span class="n">error_hint</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">db_table</span><span class="p">,</span> <span class="n">model_labels</span> <span class="ow">in</span> <span class="n">db_table_models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_labels</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">model_labels_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_labels</span><span class="p">)</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">error_class</span><span class="p">(</span>
                    <span class="s2">&quot;db_table &#39;</span><span class="si">%s</span><span class="s2">&#39; is used by multiple models: </span><span class="si">%s</span><span class="s2">.&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">db_table</span><span class="p">,</span> <span class="n">model_labels_str</span><span class="p">),</span>
                    <span class="n">obj</span><span class="o">=</span><span class="n">db_table</span><span class="p">,</span>
                    <span class="n">hint</span><span class="o">=</span><span class="p">(</span><span class="n">error_hint</span> <span class="o">%</span> <span class="n">model_labels_str</span><span class="p">)</span> <span class="k">if</span> <span class="n">error_hint</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="nb">id</span><span class="o">=</span><span class="n">error_id</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
    <span class="k">for</span> <span class="n">index_name</span><span class="p">,</span> <span class="n">model_labels</span> <span class="ow">in</span> <span class="n">indexes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_labels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">model_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">model_labels</span><span class="p">)</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Error</span><span class="p">(</span>
                    <span class="s2">&quot;index name &#39;</span><span class="si">%s</span><span class="s2">&#39; is not unique </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">index_name</span><span class="p">,</span>
                        <span class="s1">&#39;for model&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_labels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;amongst models:&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">model_labels</span><span class="p">)),</span>
                    <span class="p">),</span>
                    <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;models.E029&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_labels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;models.E030&#39;</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
    <span class="k">for</span> <span class="n">constraint_name</span><span class="p">,</span> <span class="n">model_labels</span> <span class="ow">in</span> <span class="n">constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_labels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">model_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">model_labels</span><span class="p">)</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Error</span><span class="p">(</span>
                    <span class="s2">&quot;constraint name &#39;</span><span class="si">%s</span><span class="s2">&#39; is not unique </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">constraint_name</span><span class="p">,</span>
                        <span class="s1">&#39;for model&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_labels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;amongst models:&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">model_labels</span><span class="p">)),</span>
                    <span class="p">),</span>
                    <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;models.E031&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_labels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;models.E032&#39;</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">errors</span>


<span class="k">def</span> <span class="nf">_check_lazy_references</span><span class="p">(</span><span class="n">apps</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">pending_models</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">apps</span><span class="o">.</span><span class="n">_pending_operations</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">ignore</span> <span class="ow">or</span> <span class="nb">set</span><span class="p">())</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Short circuit if there aren't any errors.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="ow">not</span> <span class="n">pending_models</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">signals</span>
    <span class="n">model_signals</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">signal</span><span class="p">:</span> <span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">signal</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">(</span><span class="n">signals</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">signals</span><span class="o">.</span><span class="n">ModelSignal</span><span class="p">)</span>
    <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Take a callable found in Apps._pending_operations and identify the
original callable passed to Apps.lazy_model_operation(). If that
callable was a partial, return the inner, non-partial function and
any arguments and keyword arguments that were supplied with it.</p>
<p>obj is a callback defined locally in Apps.lazy_model_operation() and
annotated there with a <code>func</code> attribute so as to imitate a partial.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">extract_operation</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">operation</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">keywords</span> <span class="o">=</span> <span class="n">obj</span><span class="p">,</span> <span class="p">[],</span> <span class="p">{}</span>
        <span class="k">while</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="s1">&#39;func&#39;</span><span class="p">):</span>
            <span class="n">args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="n">keywords</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="s1">&#39;keywords&#39;</span><span class="p">,</span> <span class="p">{}))</span>
            <span class="n">operation</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">func</span>
        <span class="k">return</span> <span class="n">operation</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">keywords</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">app_model_error</span><span class="p">(</span><span class="n">model_key</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">apps</span><span class="o">.</span><span class="n">get_app_config</span><span class="p">(</span><span class="n">model_key</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">model_error</span> <span class="o">=</span> <span class="s2">&quot;app &#39;</span><span class="si">%s</span><span class="s2">&#39; doesn&#39;t provide model &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">model_key</span>
        <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
            <span class="n">model_error</span> <span class="o">=</span> <span class="s2">&quot;app &#39;</span><span class="si">%s</span><span class="s2">&#39; isn&#39;t installed&quot;</span> <span class="o">%</span> <span class="n">model_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">model_error</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>Here are several functions which return CheckMessage instances for the
most common usages of lazy operations throughout Django. These functions
take the model that was being waited on as an (app_label, modelname)
pair, the original lazy function, and its positional and keyword args as
determined by extract_operation().</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">field_error</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">keywords</span><span class="p">):</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The field </span><span class="si">%(field)s</span><span class="s2"> was declared with a lazy reference &quot;</span>
            <span class="s2">&quot;to &#39;</span><span class="si">%(model)s</span><span class="s2">&#39;, but </span><span class="si">%(model_error)s</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_key</span><span class="p">),</span>
            <span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="n">keywords</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">],</span>
            <span class="s1">&#39;model_error&#39;</span><span class="p">:</span> <span class="n">app_model_error</span><span class="p">(</span><span class="n">model_key</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">Error</span><span class="p">(</span><span class="n">error_msg</span> <span class="o">%</span> <span class="n">params</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">keywords</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">],</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;fields.E307&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">signal_connect_error</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">keywords</span><span class="p">):</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%(receiver)s</span><span class="s2"> was connected to the &#39;</span><span class="si">%(signal)s</span><span class="s2">&#39; signal with a &quot;</span>
            <span class="s2">&quot;lazy reference to the sender &#39;</span><span class="si">%(model)s</span><span class="s2">&#39;, but </span><span class="si">%(model_error)s</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
        <span class="n">receiver</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>The receiver is either a function or an instance of class
defining a <code>__call__</code> method.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">):</span>
            <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;The function &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">receiver</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">receiver</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">):</span>
            <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Bound method &#39;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">receiver</span><span class="o">.</span><span class="vm">__self__</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">receiver</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;An instance of class &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">receiver</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">signal_name</span> <span class="o">=</span> <span class="n">model_signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__self__</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_key</span><span class="p">),</span>
            <span class="s1">&#39;receiver&#39;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
            <span class="s1">&#39;signal&#39;</span><span class="p">:</span> <span class="n">signal_name</span><span class="p">,</span>
            <span class="s1">&#39;model_error&#39;</span><span class="p">:</span> <span class="n">app_model_error</span><span class="p">(</span><span class="n">model_key</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">Error</span><span class="p">(</span><span class="n">error_msg</span> <span class="o">%</span> <span class="n">params</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">receiver</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;signals.E001&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">default_error</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">keywords</span><span class="p">):</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(op)s</span><span class="s2"> contains a lazy reference to </span><span class="si">%(model)s</span><span class="s2">, but </span><span class="si">%(model_error)s</span><span class="s2">.&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="n">func</span><span class="p">,</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">model_key</span><span class="p">),</span>
            <span class="s1">&#39;model_error&#39;</span><span class="p">:</span> <span class="n">app_model_error</span><span class="p">(</span><span class="n">model_key</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">Error</span><span class="p">(</span><span class="n">error_msg</span> <span class="o">%</span> <span class="n">params</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;models.E022&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>Maps common uses of lazy operations to corresponding error functions
defined above. If a key maps to None, no error will be produced.
default_error() will be used for usages that don't appear in this dict.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">known_lazy</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">(</span><span class="s1">&#39;django.db.models.fields.related&#39;</span><span class="p">,</span> <span class="s1">&#39;resolve_related_class&#39;</span><span class="p">):</span> <span class="n">field_error</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;django.db.models.fields.related&#39;</span><span class="p">,</span> <span class="s1">&#39;set_managed&#39;</span><span class="p">):</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;django.dispatch.dispatcher&#39;</span><span class="p">,</span> <span class="s1">&#39;connect&#39;</span><span class="p">):</span> <span class="n">signal_connect_error</span><span class="p">,</span>
    <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">build_error</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">keywords</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">error_fn</span> <span class="o">=</span> <span class="n">known_lazy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default_error</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">error_fn</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">keywords</span><span class="p">)</span> <span class="k">if</span> <span class="n">error_fn</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">(</span>
        <span class="n">build_error</span><span class="p">(</span><span class="n">model_key</span><span class="p">,</span> <span class="o">*</span><span class="n">extract_operation</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">model_key</span> <span class="ow">in</span> <span class="n">pending_models</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">apps</span><span class="o">.</span><span class="n">_pending_operations</span><span class="p">[</span><span class="n">model_key</span><span class="p">]</span>
    <span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">error</span><span class="p">:</span> <span class="n">error</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@register</span><span class="p">(</span><span class="n">Tags</span><span class="o">.</span><span class="n">models</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_lazy_references</span><span class="p">(</span><span class="n">app_configs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_check_lazy_references</span><span class="p">(</span><span class="n">apps</span><span class="p">)</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
